#!/bin/bash

# pcdev - Development script to run the Pinecone CLI from dist folder
# Automatically detects OS and architecture to run the correct binary

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Parse command line arguments
DEBUG=false
ARGS=()

while [[ $# -gt 0 ]]; do
    case $1 in
        --pcdev-debug)
            DEBUG=true
            shift
            ;;
        --pcdev-help)
            echo "Usage: pcdev [OPTIONS] [COMMAND_ARGS...]"
            echo ""
            echo "Options:"
            echo "  --pcdev-debug    Show pcdev debug messages"
            echo "  --pcdev-help     Show this help message"
            echo ""
            echo "Environment variables:"
            echo "  PCDEV_DEBUG    Set to '1' or 'true' to show debug messages"
            echo ""
            echo "Examples:"
            echo "  pcdev --pcdev-debug index list"
            echo "  PCDEV_DEBUG=1 pcdev index list"
            exit 0
            ;;
        *)
            ARGS+=("$1")
            shift
            ;;
    esac
done

# Check environment variable for debug mode
if [[ "$PCDEV_DEBUG" == "1" || "$PCDEV_DEBUG" == "true" ]]; then
    DEBUG=true
fi

# Function to print colored output (respects debug mode)
print_status() {
    if [[ "$DEBUG" == "true" ]]; then
        echo -e "${GREEN}[pcdev]${NC} $1" >&2
    fi
}

print_warning() {
    if [[ "$DEBUG" == "true" ]]; then
        echo -e "${YELLOW}[pcdev]${NC} $1" >&2
    fi
}

print_error() {
    # Always show errors, even in debug mode
    echo -e "${RED}[pcdev]${NC} $1" >&2
}

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DIST_DIR="$SCRIPT_DIR/dist"
CACHE_FILE="$SCRIPT_DIR/.pcdev_cache"

# Function to check if rebuild is needed
check_rebuild_needed() {
    # If dist doesn't exist, definitely need to build
    if [ ! -d "$DIST_DIR" ]; then
        return 0
    fi
    
    # If cache file doesn't exist, need to build
    if [ ! -f "$CACHE_FILE" ]; then
        return 0
    fi
    
    # Check if any Go files have been modified since last build
    local last_build_time=$(cat "$CACHE_FILE" 2>/dev/null || echo "0")
    
    # Use stat to get the most recent modification time of Go files
    local latest_file_time=0
    if command -v stat >/dev/null 2>&1; then
        # Find the most recent Go file modification time
        latest_file_time=$(find "$SCRIPT_DIR" -name "*.go" -type f -exec stat -f "%m" {} \; 2>/dev/null | sort -n | tail -1)
        if [ -z "$latest_file_time" ]; then
            latest_file_time=0
        fi
    else
        # Fallback for systems without stat
        latest_file_time=$(find "$SCRIPT_DIR" -name "*.go" -type f -printf '%T@\n' 2>/dev/null | sort -n | tail -1)
        if [ -z "$latest_file_time" ]; then
            latest_file_time=0
        fi
    fi
    
    # Compare timestamps (using integer comparison)
    if [ "$latest_file_time" -gt "$last_build_time" ]; then
        return 0
    fi
    
    return 1
}

# Function to update cache
update_cache() {
    echo "$(date +%s)" > "$CACHE_FILE"
}

# Check if rebuild is needed
if check_rebuild_needed; then
    print_warning "Source files have changed or dist directory missing. Building..."
    goreleaser build --single-target --snapshot --clean
    update_cache
    print_status "Build completed successfully!"
fi

# Check if dist directory exists (final check)
if [ ! -d "$DIST_DIR" ]; then
    print_error "dist directory not found. Please run 'goreleaser build --single-target --snapshot --clean' first."
    exit 1
fi

# Detect OS and architecture
OS=$(uname -s | tr '[:upper:]' '[:lower:]')
ARCH=$(uname -m)

print_status "Detected OS: $OS, Architecture: $ARCH"

# Determine the correct binary path
BINARY_PATH=""

case "$OS" in
    "darwin")
        # On macOS, prefer the universal binary if available
        if [ -f "$DIST_DIR/pc_darwin_all/pc" ]; then
            BINARY_PATH="$DIST_DIR/pc_darwin_all/pc"
            print_status "Using universal binary (works on both Intel and Apple Silicon)"
        elif [ -f "$DIST_DIR/pc_darwin_arm64_v8.0/pc" ]; then
            BINARY_PATH="$DIST_DIR/pc_darwin_arm64_v8.0/pc"
            print_status "Using ARM64 binary"
        elif [ -f "$DIST_DIR/pc_darwin_amd64/pc" ]; then
            BINARY_PATH="$DIST_DIR/pc_darwin_amd64/pc"
            print_status "Using AMD64 binary"
        else
            print_error "No suitable macOS binary found in dist directory"
            print_status "Available binaries:"
            ls -la "$DIST_DIR"/*/pc 2>/dev/null || echo "No binaries found"
            exit 1
        fi
        ;;
    "linux")
        case "$ARCH" in
            "x86_64"|"amd64")
                if [ -f "$DIST_DIR/pc_linux_amd64/pc" ]; then
                    BINARY_PATH="$DIST_DIR/pc_linux_amd64/pc"
                elif [ -f "$DIST_DIR/pc_linux_x86_64/pc" ]; then
                    BINARY_PATH="$DIST_DIR/pc_linux_x86_64/pc"
                fi
                ;;
            "aarch64"|"arm64")
                if [ -f "$DIST_DIR/pc_linux_arm64/pc" ]; then
                    BINARY_PATH="$DIST_DIR/pc_linux_arm64/pc"
                fi
                ;;
            "armv7l"|"arm")
                if [ -f "$DIST_DIR/pc_linux_arm/pc" ]; then
                    BINARY_PATH="$DIST_DIR/pc_linux_arm/pc"
                fi
                ;;
        esac
        
        if [ -z "$BINARY_PATH" ]; then
            print_error "No suitable Linux binary found for architecture $ARCH"
            print_status "Available binaries:"
            ls -la "$DIST_DIR"/*/pc 2>/dev/null || echo "No binaries found"
            exit 1
        fi
        ;;
    "mingw64_nt"*|"msys_nt"*|"cygwin"*)
        # Windows (Git Bash, MSYS2, Cygwin)
        if [ -f "$DIST_DIR/pc_windows_amd64/pc.exe" ]; then
            BINARY_PATH="$DIST_DIR/pc_windows_amd64/pc.exe"
        elif [ -f "$DIST_DIR/pc_windows_x86_64/pc.exe" ]; then
            BINARY_PATH="$DIST_DIR/pc_windows_x86_64/pc.exe"
        else
            print_error "No suitable Windows binary found"
            print_status "Available binaries:"
            ls -la "$DIST_DIR"/*/pc.exe 2>/dev/null || echo "No binaries found"
            exit 1
        fi
        ;;
    *)
        print_error "Unsupported operating system: $OS"
        exit 1
        ;;
esac

# Check if binary exists and is executable
if [ ! -f "$BINARY_PATH" ]; then
    print_error "Binary not found: $BINARY_PATH"
    exit 1
fi

if [ ! -x "$BINARY_PATH" ]; then
    print_warning "Binary is not executable, making it executable..."
    chmod +x "$BINARY_PATH"
fi

print_status "Running: $BINARY_PATH ${ARGS[*]}"

# Execute the binary with all passed arguments
exec "$BINARY_PATH" "${ARGS[@]}" 